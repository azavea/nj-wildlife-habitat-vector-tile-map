<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NJ Wildlife Habitat Viewer">
    <title>NJ Wildlife Habitat Viewer</title>
    <link rel="shortcut icon" href="images/New-Jersey-favicon.png">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="css/main.css" />

    <!-- Mapbox GL JS -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.css' rel='stylesheet' />

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>

    <!-- Turf.js -->
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>

    <!-- Mapbox GL JS Draw -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.0/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.0/mapbox-gl-draw.css' type='text/css'/>

    <!-- Mapbox GL JS Geocoder -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.1/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.1/mapbox-gl-geocoder.css' type='text/css' />

    <!-- Font Awesome icon library -->
    <script src="https://use.fontawesome.com/e1061b6f05.js"></script>
</head>
<body>
    <div class="grid">
        <!-- Header -->
        <div class="header">
            <div class="learn-more-btn">
                <a href="#" id="modal-btn" class="btn btn-blue">Learn more</a>
            </div>
            <div class="logo">
                <a href="http://www.azavea.com" target="_blank"><img src="images/azavea_rgb_solo.svg"></a>
                <p class="subtitle"> an Azavea R&amp;D Project</p>
            </div>
        </div>
        <!-- Header -->
        <!-- Title -->
        <div class="title">
            <h1>NJ Wildlife Habitat Viewer</h1>
        </div>
        <!-- Title -->
        <!-- Sidebar -->
        <sidebar>
            <!-- Geocoder -->
            <div class="block">
                <div id="geocoder-container" class="geocoder-container"></div>
            </div>
            <div class="block"></div>
            <!-- Geocoder -->
            <div class="block">
                <p>Enter an address to zoom to an area on the map, then select parcels or draw a custom shape.</p>
            </div>
        </sidebar>
        <!-- Sidebar -->
        <!-- Map -->
        <maparea id="map"></maparea>
        <!-- Map -->
        <!-- Legend -->
        <div id='heatmap-legend' class='legend' style='display: block;'>
            <h4>Heatmap</h4>
            <div><span style='background-color: rgba(236,222,239,0)'></span>0</div>
            <div><span style='background-color: rgba(208,209,230,50)'></span>0.2</div>
            <div><span style='background-color: rgba(166,189,219,100)'></span>0.4</div>
            <div><span style='background-color: rgba(103,169,207,200)'></span>0.6</div>
            <div><span style='background-color: rgba(28,144,153,255)'></span>0.8</div>
        </div>
        <div id='habitat-legend' class='legend' style='display: none;'>
            <h4>Wildlife Habitat</h4>
            <div><span style='background-color: #fffbb2'></span>Habitat Specific Requirements</div>
            <div><span style='background-color: #e1cca2'></span>Special Concern</div>
            <div><span style='background-color: #cce1a2'></span>State Threatened</div>
            <div><span style='background-color: #9bb88f'></span>State Endangered</div>
            <div><span style='background-color: #78aa94'></span>Federal Listed</div>
        </div>
    </div>
    <!-- Legend -->
    <!-- Modal -->
    <div id="about-modal" class="modal">
    <!-- Modal Content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close"><i class="fa fa-times" aria-hidden="true"></i></span>
                <h3>Making environmental inventory fast.</h3>
            </div>
            <div class="modal-body">
                <h4>About this tool</h4>
                <p>This map displays NJDEP Landscape Project 3.3 wildlife habitat for the state of New Jersey. Wildlife habitat is displayed as a generalized heat map at low zoom levels and detailed land-use land-cover polygons at high zoom levels.</p>
                <h4>About the data</h4>
                <p><a href="http://www.state.nj.us/dep/fgw/ensp/landscape/index.htm" target='_blank'>New Jersey Landscape Project</a> is a database that combines imperiled and priority species location information with land-use/land-cover (LULC) data. The dataset in made up of hundreds of thousands of polygons with continuous, topological coverage for the entire state and several associated tables with rich attribute information about habitat type and wildlife sighting records.</p>
                <p>Landscape Project species habitat areas are determined by running species-specific models on a wildlife observation point dataset. NJDEP ENSP biologists create habitat models for each NJ Special Concern, Threatened, and Endangered species, including Federal Threatened and Endangered species, using a combination of species biology (i.e. movement patterns, habitat preferences, home ranges, etc) and statewide LULC polygons to create potential habitat areas. <a href="https://njdep.maps.arcgis.com/apps/Cascade/index.html?appid=6cd21ef042634609904beae390f34482" target='_blank'>View the story map</a> produced by the NJDEP to learn more about Landscape Project 3.3 data.</p>
                <h4>Solving difficult problems</h4>
                <p>It can be challenging to determine a list of wildlife habitat on a specific site, even if youâ€™re in the environmental consulting/regulatory compliance world and have experience with GIS software. Other online tools that explore Landscape Project data exist, but load time is slow and retrieving lists for a user-selected area is not possible.</p>
                <p>Through the creation of this Proof of Concept we investigated a workflow to process a large dataset into vector tiles that can be rendered responsively in a web browser with <a href="https://www.mapbox.com/" target='_blank'>Mapbox</a> services and <a href="https://www.mapbox.com/mapbox-gl-js/api/" target='_blank'>Mapbox GL JS.</a></p>
                <p>Read in detail about the steps we took to create this tool in <a href="#" target='_blank'>this blog post</a> and explore other Azavea 10% Research Projects at <a href="https://www.azavea.com/research/" target='_blank'>azavea.com/research</a>.
                <h4>Future possibilities</h4>
                <p>This tool solves a specific set of problems, but it is an example of what is possible if we apply the methods used in this Proof of Concept to a similar need.</p>
                <p>What is your current process for conducting environmental inventories? If you would like to hear more about how we can help you build a tool that maximizes efficiency and accuracy for site inventories, <a href="#" target='_blank'>contact us today.</a></p>
            </div>
            <div class="modal-footer">
                <table>
                    <tbody>
                        <tr><td class="table-center"><a href="https://www.azavea.com/blog/" target="_blank"><i class="fa fa-external-link"></i></a></td><td class="table-column"><a href="https://www.azavea.com/blog/" target="_blank">learn how we built this tool</a></td></tr>
                        <tr><td class="table-center"><a href="#" target="_blank"><i class="fa fa-envelope"></i></a></td><td class="table-column"><a href="#" target="_blank">contact our team to build your own</a></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal -->

<!-- IMPORTANT: Configuration of application tokens, tilesources, and host URL is in a seperate script "config.js". This script must be manually updated.-->
<script src="config.js"></script>

<script>

// Map pan and zoom contraints for New Jersey
const NJ_MAP_LIMITS = {
  minZoom: 7,
  bounds: [[-76.151,38.638],[-73.128,41.572]]
}

// Object to manage application state
const APP = {
  initialMapLoaded: false,
  mode: 'draw',
  areaOfInterest: { type: 'FeatureCollection', features: [] },
  contextFeatures: { type: 'FeatureCollection', features: [] },
  featuresOfInterest: { type: 'FeatureCollection', features: [] }
}

mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
const MAP = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/satellite-streets-v9',
  zoom: 7,
  center: [-74.596258, 40.195586],
  hash: true,
  minZoom: NJ_MAP_LIMITS.minZoom,
  maxBounds: NJ_MAP_LIMITS.bounds
});

MAP.addControl(new mapboxgl.NavigationControl());

const GEOCODER = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    placeholder:"Type address here",
    proximity: {
        latitude: 40.195586,
        longitude: -74.596258
    }
});

document.getElementById('geocoder-container').appendChild(GEOCODER.onAdd(MAP))

// Setup drawing tool
const DRAW = new MapboxDraw({
  displayControlsDefault: false,
  controls: {
    polygon: true,
    trash: true
  }
});
MAP.addControl(DRAW);

// Add popup data window for habitat vector tile data
const POPUP = new mapboxgl.Popup ({
    closeButton: true,
    closeOnClick: false
});

MAP.on('render', updateApp);
MAP.on('moveend', updateApp);

// Listen for updates to the drawing
MAP.on('draw.create', updateAreaOfInterest);
MAP.on('draw.delete', updateAreaOfInterest);
MAP.on('draw.update', updateAreaOfInterest);

MAP.on('load', () => {
  APP.initialMapLoaded = true;

  let mapStyleLayers = MAP.getStyle().layers;
  // Find the index of the first symbol layer in the map style
  let firstSymbolId;
  for (let i = 0; i < mapStyleLayers.length; i++) {
      if (mapStyleLayers[i].type === 'symbol') {
          firstSymbolId = mapStyleLayers[i].id;
          break;
      }
  }

  // Add Habitats Areas
  MAP.addSource('nj-habitat-areas', {
    type: 'vector',
    url: TILE_SOURCES.habitatAreas
  });
  MAP.addLayer({
    "id": "nj-habitat-areas",
    "source": "nj-habitat-areas",
    "source-layer": "featurestxt",
    "minzoom": 13,
    "type": "fill",
    "paint": {
      "fill-color": {
            property: 'LNDR',
            stops: [
                [1, '#fffbb2'],
                [2, '#e1cca2'],
                [3, '#cce1a2'],
                [4, '#9bb88f'],
                [5, '#78aa94']]
            },
      "fill-opacity": 0.4,
      "fill-outline-color": "#fff"
    }
}, firstSymbolId);

  // Add Sightings Overview
  MAP.addSource('nj-habitat-overview', {
    type: 'vector',
    url: TILE_SOURCES.habitatOverview
  });
  MAP.addLayer({
    "id": "nj-habitat-overview",
    "source": "nj-habitat-overview",
    "source-layer": "habitatoverview2017",
    "maxzoom": 13,
    "type": "heatmap",
    "paint": {
      // increase weight as diameter breast height increases
      'heatmap-weight': {
        property: 'acres',
        type: 'exponential',
        stops: [
          [1, 0],
          [10, 1]
        ]
      },
      // increase intensity as zoom level increases
      'heatmap-intensity': {
        stops: [
          [7, 0.2],
          [11, 0.5]
        ]
      },
      // assign color values be applied to points depending on their density
      'heatmap-color': [
        'interpolate',
        ['linear'],
        ['heatmap-density'],
        0, 'rgba(236,222,239,0)',
        0.2, 'rgba(208,209,230,50)',
        0.4, 'rgba(166,189,219,100)',
        0.6, 'rgba(103,169,207,200)',
        0.8, 'rgba(28,144,153,255)'
      ],
      // increase radius as zoom increases
      'heatmap-radius': {
        stops: [
          [9, 2],
          [13, 8]
        ]
      },
      // decrease opacity to transition into the circle layer
      'heatmap-opacity': {
        default: 1,
        stops: [
          [12, 1],
          [14, 0]
        ]
      }
    }
}, firstSymbolId);

  // When a click event occurs near a place, open a popup at the location of
  // the feature, with HTML description from its properties
  MAP.on('click', function(e) {
    POPUP.remove();
    if (DRAW.getMode() !== 'draw_polygon' && DRAW.getAll().features.length === 0) {
      let features = MAP.queryRenderedFeatures(e.point, { layers: ['nj-habitat-areas'] });

      // if the features have no info, return nothing
      if (!features.length) {
        return;
      }

      let feature = features[0];
      let featureLINKID = feature.properties.LINKID;

      // Populate the popup and set its coordinates
      // based on the feature found
      POPUP.setLngLat(e.lngLat);
      POPUP.setHTML('<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'> <h3>Habitat ' + featureLINKID + '</h3>' +
      '<p><a href=\'' + HOST + '/habitat/' + featureLINKID + '.json' + '\' download>Download GeoJSON</a></p>' +
      '<p> Federal Endangered: ' + feature.properties['insert-federal-listed'] + ' </p>' +
      '<p> Federal Threatened: ' + feature.properties['insert-federal-listed'] + ' </p>' +
      '<p> State Endangered: ' + feature.properties['insert-state-listed'] + ' </p>' +
      '<p> State Threatened: ' + feature.properties['insert-state-listed'] + ' </p></div>');
      POPUP.addTo(MAP);
    }
  });

  // Use the same approach as above to indicate that the symbols are clickable
  // by changing the cursor style to 'pointer'
  MAP.on('mousemove', function(e) {
    if (DRAW.getMode() !== 'draw_polygon' && DRAW.getSelectedIds().length === 0) {
      var features = MAP.queryRenderedFeatures(e.point, { layers: ['nj-habitat-areas'] });
      MAP.getCanvas().style.cursor = features.length ? 'pointer' : '';
    } else if (DRAW.getMode() === 'draw_polygon') {
      MAP.getCanvas().style.cursor = 'crosshair';
    } else if (DRAW.getMode() === 'simple_select') {
      MAP.getCanvas().style.cursor = 'pointer';
    }
  });
});

function updateApp() {
  // Immediately remove map annotation if zoom is less than 13
  if (MAP.getZoom() < 13) {
    POPUP.remove();
  }

  // determine if loaded
  if (APP.initialMapLoaded && MAP.loaded()) {
    setReady();

    let zoom = MAP.getZoom();

    if (zoom < 13) {
      // Render "Search for Address or Zoom to Region"
      renderZoomPrompt();
      APP.state = 0;
    } else if (zoom >= 13 && APP.areaOfInterest.features.length === 0) {
      // Render "Select Area of Interest"
      APP.state = 1;
      renderSelectAreaOfInterestPrompt();
    } else if (zoom >= 13 && APP.areaOfInterest.features.length > 0) {
      if (APP.state !== 2) {
        // Wait if processing not complete
        if (APP.featuresOfInterest.features.length > 0) {
          // Render "Display Area of Interest Analysis with Species List"
          APP.state = 2;
          renderAreaOfInterestReport();
        } else {
          setLoading();
        }
      }
    }
  } else {
    setLoading();
  }
}

function setReady() {
  //console.log('ready');
}

function setLoading() {
  //console.log('loading');
}

// Render Application State 0: Prompt user to zoom to an area of interest
function renderZoomPrompt() {
  console.log('Zoom to a region.');
  document.getElementById('habitat-legend').style.display = 'none';
  document.getElementById('heatmap-legend').style.display = 'block';
}

// Render Application State 1: Prompt user to select an area of interest
function renderSelectAreaOfInterestPrompt() {
  console.log('Select an area.');
  document.getElementById('habitat-legend').style.display = 'block';
  document.getElementById('heatmap-legend').style.display = 'none';

}

// Render Application State 2: Report on user's selected area of interest
function renderAreaOfInterestReport() {
  console.log(JSON.stringify(APP.featuresOfInterest));
  APP.featuresOfInterest.features.map(function(f) {
    f.properties.species.map(function(s) {
      console.log(s);
    });
  });
}

function updateAreaOfInterest() {
  APP.areaOfInterest = turf.combine(DRAW.getAll());

  if (APP.areaOfInterest.features.length > 0) {

    frameMap();
    constrainMap();

    let tileFeatures = MAP.queryRenderedFeatures({ layers: [ 'nj-habitat-areas' ] });

    let tileFeatureLINKIDs = tileFeatures.map((feature) => {
      return feature.properties.LINKID;
    });

    let LINKIDs = tileFeatureLINKIDs.filter((id, index) => {
      return tileFeatureLINKIDs.indexOf(id) === index;
    }).sort();

    // Download GeoJSON //
    // Initialize a queue of requests
    var q = d3.queue()
    // Make a request for the raw GeoJSON of each LINKID habitat
    for (var i = 0; i < LINKIDs.length; i++) {
      // Request GeoJSON files from `habitat` directory
      q.defer(d3.json, HOST + '/habitat/' + LINKIDs[i] + '.json')
    }
    // Wait for all the individual GeoJSON habitats to load
    q.awaitAll(function(error, data) {
      APP.contextFeatures = turf.featureCollection(data);

      let habitatData = APP.contextFeatures;
      let intersectionArea = APP.areaOfInterest.features[0];

      // Clip each feature in the FeatureCollection by the drawing's area of interest
      let intersectingHabitat = turf.featureCollection(habitatData.features.map((f) => {
        let clippedFeature = turf.intersect(intersectionArea, f);
        if (clippedFeature) { clippedFeature.properties = f.properties; }
        return clippedFeature;
      }).filter(function(f) { return f; })); // Filter out null features (didn't intersect with area of interest)

      APP.featuresOfInterest = intersectingHabitat;

      updateApp();
    });
  } else {
    APP.contextFeatures = turf.featureCollection([]);
    APP.featuresOfInterest = turf.featureCollection([]);
    unconstrainMap();
    updateApp();
  }
}

function frameMap() {
  if (APP.areaOfInterest.features.length > 0) {
    let bounds = turf.bbox(APP.areaOfInterest);
    MAP.fitBounds(bounds, { duration: 0, padding: 50}); // duration: 0 makes this synchronous
  }
}

// Limit the map zooming and panning to within the current frame
function constrainMap() {
  MAP.setMaxBounds(MAP.getBounds());
  MAP.setMinZoom(MAP.getZoom());
}

// Limit the map zooming and panning to only within NJ limits
function unconstrainMap() {
  MAP.setMaxBounds(NJ_MAP_LIMITS.bounds);
  MAP.setMinZoom(NJ_MAP_LIMITS.minZoom);
}

</script>

<script>
// Get the modal
var modal = document.getElementById('about-modal');

// Get the button that opens the modal
var btn = document.getElementById("modal-btn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal
btn.onclick = function() {
    modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>
</body>
</html>
